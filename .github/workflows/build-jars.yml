name: Build Jars

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Leiningen
        run: |
          curl https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein > lein
          chmod +x lein
          ./lein self-install
          ./lein version

      - name: Build uberjar
        env:
          LEIN_SNAPSHOTS_IN_RELEASE: true
        run: |
          ./lein clean
          ./lein uberjar

      - name: Upload standalone uberjar
        uses: actions/upload-artifact@v4
        with:
          name: spider-game
          path: target/**/*-standalone.jar

  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Leiningen
        run: |
          curl https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein > lein
          chmod +x lein
          ./lein self-install
          ./lein version

      - name: Build uberjar
        env:
          LEIN_SNAPSHOTS_IN_RELEASE: true
        run: |
          ./lein clean
          ./lein uberjar

      - name: Rename standalone jar for macOS
        run: |
          jar=$(ls target/uberjar/*-standalone.jar | head -n 1 || true)
          if [ -z "$jar" ]; then
            echo "No standalone jar found"; exit 1
          fi
          fname=$(basename "$jar")
          prefix=${fname%-standalone.jar}
          newname="${prefix}_macos.jar"
          mv "$jar" "target/uberjar/$newname"

      - name: Upload uberjar for macOS
        uses: actions/upload-artifact@v4
        with:
          name: spider-game_macos
          path: target/uberjar/*_macos.jar

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Download lein.bat
        shell: powershell
        run: |
          Invoke-WebRequest https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein.bat -OutFile lein.bat

      - name: Bootstrap Leiningen
        shell: powershell
        run: |
          # first download the self-installs
          ./lein.bat self-install
          # verify version (forces jar download if self-install wasnâ€™t enough)
          ./lein.bat version

      - name: Build uberjar
        shell: powershell
        env:
          LEIN_SNAPSHOTS_IN_RELEASE: true
        run: |
          ./lein.bat clean
          ./lein.bat uberjar

      - name: Upload uberjar
        uses: actions/upload-artifact@v4
        with:
          name: spider-game_windows
          path: target/**/*-standalone.jar
